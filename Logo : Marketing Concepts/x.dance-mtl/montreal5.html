<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x.dance // MONTREAL</title>
    <meta name="description" content="x.dance: Operational Protocol for Montreal Dance Access. Your comprehensive resource to locate 'the dance' in Montreal.">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='80' text-anchor='middle' dominant-baseline='central'%3Ex%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap');

        :root {
            --bg-color: #000000;
            --text-color: #F0F0F0;
            --terminal-border: #1a1a1a;
            --terminal-glow: #00ff66; /* Subtle green for terminal elements */
            --x-inner-color: #FFFFFF;
            --x-border-color: #000000;
            --selected-day-bg: rgba(0, 255, 102, 0.2); /* Highlight for selected day */
            --today-mark-color: yellow; /* Mark for "today" specifically */
            --tab-hover-bg: rgba(0, 255, 102, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'IBM Plex Mono', monospace; /* Primary font for terminal feel */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Fixed Header Section --- */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-color);
            z-index: 1000; /* Ensure it stays on top */
            padding: 20px 0; /* Vertical padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); /* Subtle shadow for fixed header */
            text-align: center;
            border-bottom: 1px solid var(--terminal-border); /* Subtle separator */
            box-sizing: border-box; /* Include padding in width */
            
            /* Apply the industrial glow ONLY to this header section */
            border: 1px solid var(--terminal-border); /* Main border */
            box-shadow: 0 0 10px rgba(0, 255, 102, 0.1), inset 0 0 10px rgba(0, 255, 102, 0.1);
            animation: industrialGlow 5s infinite alternate ease-in-out;
        }

        @keyframes industrialGlow {
            0% { box-shadow: 0 0 10px rgba(0, 255, 102, 0.1), inset 0 0 10px rgba(0, 255, 102, 0.1); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 102, 0.2), inset 0 0 15px rgba(0, 255, 102, 0.2); }
            100% { box-shadow: 0 0 10px rgba(0, 255, 102, 0.1), inset 0 0 10px rgba(0, 255, 102, 0.1); }
        }

        /* --- X Logo Styling (Copied from index.html) --- */
        .x-logo {
            font-family: 'Rajdhani', sans-serif;
            font-size: 5em; /* Slightly smaller for header, but still prominent */
            font-weight: 700;
            line-height: 0.8;
            position: relative;
            display: inline-block;
            text-align: center;
            width: 1em;
            height: 1em;
            overflow: hidden;
            animation: xFightBack 6s infinite ease-in-out;
            margin-bottom: 10px; /* Space below logo */
        }
        
        .x-logo::before { /* Apply 'x' content */
            content: 'x';
            color: var(--x-inner-color);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .x-logo::after { /* Apply color layer */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #FF00FF, #00FFFF, #FFFF00);
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease-out;
        }

        @keyframes xFightBack { /* Apply to both sizes */
            0%, 100% { opacity: 1; filter: grayscale(0); }
            20% { opacity: 1; filter: grayscale(1); }
            25% { opacity: 0.5; filter: grayscale(0); }
            30% { opacity: 1; filter: grayscale(1); }
            70% { opacity: 1; filter: grayscale(1); }
            75% { opacity: 0.5; filter: grayscale(0); }
            80% { opacity: 1; filter: grayscale(1); }
        }

        /* --- Page Title / Subtitle & Main Nav Dropdown --- */
        .page-title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        .page-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.8em;
            color: var(--text-color);
            letter-spacing: 0.05em;
            margin: 0; /* Remove default h1 margin */
        }
        .page-title span { /* For the city name glow */
            color: var(--terminal-glow);
            text-shadow: 0 0 5px var(--terminal-glow);
        }

        .main-nav-dropdown {
            background-color: var(--bg-color);
            border: 1px solid var(--terminal-glow);
            color: var(--terminal-glow);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em; /* Slightly smaller than title for hierarchy */
            padding: 5px 10px;
            margin-left: 15px; /* Space from title */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 255, 102, 0.3);
            transition: all 0.3s ease-in-out;
            max-width: 150px; /* Control width */
        }
        .main-nav-dropdown option {
            background-color: var(--bg-color);
            color: var(--terminal-glow);
        }
        .main-nav-dropdown:hover,
        .main-nav-dropdown:focus {
            box-shadow: 0 0 10px rgba(0, 255, 102, 0.6);
        }


        /* --- Date Bar --- */
        .date-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            max-width: 600px;
            padding: 10px 0;
            font-size: 0.9em;
        }

        .date-bar .day-option {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid var(--terminal-border);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
            position: relative; /* For the 'today' mark */
            user-select: none; /* Prevent text selection */
        }

        .date-bar .day-option:hover {
            background-color: var(--selected-day-bg);
            box-shadow: 0 0 8px rgba(0, 255, 102, 0.4);
            color: var(--terminal-glow);
        }

        .date-bar .day-option.selected {
            background-color: var(--selected-day-bg);
            border-color: var(--terminal-glow);
            box-shadow: 0 0 10px rgba(0, 255, 102, 0.6);
            color: var(--terminal-glow);
        }

        .date-bar .day-option.is-today::after {
            content: '*'; /* A simple mark for 'today' */
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8em;
            color: var(--today-mark-color);
        }

        .date-bar .date-dropdown {
            background-color: var(--bg-color);
            border: 1px solid var(--terminal-glow);
            color: var(--terminal-glow);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1em;
            padding: 5px 10px;
            margin-left: 20px; /* Space from day options */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 255, 102, 0.3);
            transition: all 0.3s ease-in-out;
        }

        .date-bar .date-dropdown option {
            background-color: var(--bg-color);
            color: var(--terminal-glow);
        }

        .date-bar .date-dropdown:hover,
        .date-bar .date-dropdown:focus {
            box-shadow: 0 0 10px rgba(0, 255, 102, 0.6);
        }

        /* --- Sort/Filter Bar --- */
        .sort-filter-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto 0 auto; /* Space from date bar, centered */
            max-width: 600px;
            border-top: 1px dashed var(--terminal-border); /* Divider from date bar */
            padding-top: 15px;
            font-size: 0.9em;
        }

        .sort-filter-bar .tab-option {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid transparent; /* No border by default */
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px; /* Space between text and arrow */
        }

        .sort-filter-bar .tab-option:hover {
            background-color: var(--tab-hover-bg);
            color: var(--terminal-glow);
        }

        .sort-filter-bar .tab-option.active {
            border-color: var(--terminal-glow);
            box-shadow: 0 0 8px rgba(0, 255, 102, 0.4);
            color: var(--terminal-glow);
        }

        .sort-filter-bar .tab-option .arrow {
            font-family: 'IBM Plex Mono', monospace; /* Ensure monospace arrow */
            font-size: 0.8em;
            line-height: 1;
            width: 1em; /* Fixed width for arrow */
            text-align: center;
            color: var(--terminal-glow);
        }

        /* --- Main Content Area --- */
        .main-content {
            margin-top: 340px; /* Adjusted to accommodate new dropdown in header */
            padding: 40px 20px;
            width: 90%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
            color: var(--text-color);
            font-size: 0.9em;
            line-height: 1.8; /* More space for readability */
        }

        /* All content sections are hidden by default and shown by JS */
        .content-section {
            display: none; /* Hidden by default */
        }
        .content-section.active {
            display: block; /* Shown when active */
        }

        .section-heading {
            font-size: 1.4em;
            color: var(--terminal-glow);
            text-shadow: 0 0 5px var(--terminal-glow);
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--terminal-border); /* Subtle divider */
            padding-bottom: 5px;
            letter-spacing: 0.03em;
        }

        .event-listing, .venue-item, .dancemaker-profile {
            margin-bottom: 25px; /* Space between items */
            padding: 10px 0;
            border-bottom: 1px dotted rgba(240, 240, 240, 0.1); /* Very subtle separator */
        }

        .event-listing:last-child, .venue-item:last-child, .dancemaker-profile:last-child {
            border-bottom: none; /* No border for the last one */
        }

        .event-listing .time {
            color: var(--terminal-glow);
            font-weight: bold;
            margin-right: 10px;
        }

        .event-listing .type, .event-listing .location {
            color: var(--text-color);
        }
        
        .event-listing .status {
            color: var(--today-mark-color); /* Use yellow for active status */
            margin-left: 10px;
            font-weight: bold;
        }

        .event-listing .details-link, .venue-item .details-link, .dancemaker-profile .details-link {
            color: var(--terminal-glow);
            text-decoration: none;
            margin-left: 15px;
            white-space: nowrap; /* Keep link on one line */
        }
        .event-listing .details-link:hover, .venue-item .details-link:hover, .dancemaker-profile .details-link:hover {
            text-decoration: underline;
        }

        /* For grouped sections and individual items */
        .group-heading {
            font-size: 1.2em;
            color: var(--terminal-glow);
            margin-top: 40px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 255, 102, 0.3); /* Stronger divider for groups */
        }
        .venue-item p, .dancemaker-profile p, .overview-text p { /* Basic text formatting */
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .venue-item .group-heading, .dancemaker-profile .group-heading { /* Sub-headings for items */
            font-size: 1.1em;
            margin-top: 0;
            border-bottom: none;
            color: var(--text-color); /* Default text color for item headings */
        }


        /* --- End of Content Marker --- */
        .end-marker {
            text-align: center;
            margin-top: 80px;
            margin-bottom: 100px; /* Space at bottom to ensure it's visible */
            color: rgba(240, 240, 240, 0.4);
            font-size: 0.8em;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .x-logo {
                font-size: 3.5em; /* Smaller on mobile */
            }
            .page-title {
                font-size: 1.4em;
            }
            .page-title-container {
                flex-direction: column;
                margin-bottom: 10px;
            }
            .main-nav-dropdown {
                margin-left: 0;
                margin-top: 10px;
                width: 80%;
            }
            .date-bar {
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
                justify-content: center;
                font-size: 0.8em;
            }
            .date-bar .day-option {
                padding: 6px 10px;
                margin: 5px;
            }
            .date-bar .date-dropdown {
                margin-left: 0;
                margin-top: 10px;
                width: 80%;
            }
            .sort-filter-bar {
                flex-wrap: wrap;
                justify-content: center;
                font-size: 0.8em;
                margin-top: 10px;
            }
            .sort-filter-bar .tab-option {
                padding: 6px 10px;
                margin: 5px;
            }
            .main-content {
                margin-top: 310px; /* Adjusted for smaller fixed header on mobile */
                padding: 20px 10px;
                font-size: 0.8em;
            }
            .section-heading {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header-fixed">
        <div class="x-logo"></div>
        <div class="page-title-container">
            <h1 class="page-title">x.dance // <span>MONTREAL</span></h1>
            <select class="main-nav-dropdown" id="main-nav-dropdown">
                <option value="dances-section" selected>Dances</option>
                <option value="overview-section">Overview</option>
                <option value="venues-section">Venues</option>
                <option value="dancemakers-section">Dancemakers</option>
            </select>
        </div>
        <div class="date-bar" id="date-bar">
            <!-- Day options will be generated here by JavaScript -->
        </div>
        <div class="sort-filter-bar" id="sort-filter-bar">
            <div class="tab-option" data-sort-key="time" data-sort-state="asc">TIME <span class="arrow">▲</span></div>
            <div class="tab-option" data-sort-key="type" data-sort-state="neutral">GENRE <span class="arrow"></span></div>
            <div class="tab-option" data-sort-key="location" data-sort-state="neutral">VENUE <span class="arrow"></span></div>
            <div class="tab-option" data-sort-key="status" data-sort-state="neutral">STATUS <span class="arrow"></span></div>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <!-- DANCES SECTION -->
        <div id="dances-section" class="content-section active">
            <h2 class="section-heading" id="current-date-heading">DANCES TODAY</h2>
            <div class="events-list" id="events-list">
                <!-- Event listings will be generated/manipulated by JavaScript -->
            </div>
        </div>

        <!-- OVERVIEW SECTION -->
        <div id="overview-section" class="content-section">
            <h2 class="section-heading">OVERVIEW</h2>
            <div class="overview-text">
                <p>> Welcome to the Montreal Dance Protocol. This city's pulse is deep, rhythm-driven, and notoriously vibrant. Operations typically conclude around 03:00 local time for alcohol consumption, though after-hours continuity can be found. Strict ID verification is standard across all access points. Key operational zones include: Plateau, Mile End, Griffintown, and various undisclosed warehouse coordinates.</p>
                <p>> Expect a highly engaged and discerning local user base. Scene consciousness is paramount. New initiates are advised to observe and integrate into the local frequency before attempting high-level engagement.</p>
                <p>> Current operational temperature: OPTIMAL.</p>
            </div>
        </div>

        <!-- VENUES SECTION -->
        <div id="venues-section" class="content-section">
            <h2 class="section-heading">VENUES</h2>
            <div class="venue-item">
                <h3 class="group-heading">CONCRETE FACTORY</h3>
                <p>> Location: Industrial Zone 7B. Access Protocol: Discreet. Known for raw, unadulterated techno. Expect powerful sound systems and a focused dancefloor. Identification required. Capacity: High. Operational hours: FRI-SAT 22:00 - 03:00 (primary). Tips: Hydration critical. Ear protection advised.</p>
            </div>
            <div class="venue-item">
                <h3 class="group-heading">THE SOUND CHAMBER</h3>
                <p>> Location: Downtown Sub-Level. Access Protocol: Standard. Specializes in immersive deep and minimal house experiences. Acoustic engineering optimized for clarity. Identification required. Capacity: Medium. Operational hours: THU-SAT 21:00 - 02:00. Tips: Engage with the sonic landscape. Personal space respected.</p>
            </div>
            <div class="venue-item">
                <h3 class="group-heading">ROOFTOP GARDEN</h3>
                <p>> Location: Urban Core, Elevated. Access Protocol: Limited. Seasonal operations. Known for open-air house and disco grooves with city skyline data-views. Identification required. Capacity: Low. Operational hours: Seasonal SUN-TUE 19:00 - 01:00. Tips: Arrive early for prime position. Expect high energy and social interface.</p>
            </div>
        </div>

        <!-- DANCEMAKERS SECTION -->
        <div id="dancemakers-section" class="content-section">
            <h2 class="section-heading">DANCEMAKERS</h2>
            <div class="dancemaker-profile">
                <h3 class="group-heading">OPERATOR: SYNTHETIC_MIND</h3>
                <p>> Role: Primary Sonic Architect (DJ/Producer). Profile: Known for meticulously crafted industrial techno sets, pushing the boundaries of rhythm and texture. Deeply committed to advancing local soundscapes. Affiliation: Concrete Collective. Latest Transmission: 'System Override' EP (Self-Released, 2024). Protocol_Links: [AUDIO_STREAM] [LIVE_PERFORMANCE_LOG]</p>
            </div>
            <div class="dancemaker-profile">
                <h3 class="group-heading">CURATOR: RHYTHM_ENGINE</h3>
                <p>> Role: Scene Integrator (Promoter/Organizer). Profile: Drives underground house and disco activations in unconventional spaces. Focuses on fostering inclusive dance environments and supporting emerging local talent. Network: Montreal Groove Alliance. Upcoming Operations: 'Warehouse Rejuvenation' (Monthly Series). Protocol_Links: [TRANSMISSION_LOG] [CONTRIBUTION_MANIFEST]</p>
            </div>
        </div>

        <div class="end-marker">
            &lt;END OF DANCE LOG&gt;
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateBar = document.getElementById('date-bar');
            const sortFilterBar = document.getElementById('sort-filter-bar');
            const eventsListContainer = document.getElementById('events-list');
            const currentDateHeading = document.getElementById('current-date-heading');
            const mainNavDropdown = document.getElementById('main-nav-dropdown');
            const contentSections = document.querySelectorAll('.content-section');

            const daysOfWeek = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

            let today = new Date(); 
            today.setHours(0, 0, 0, 0); 
            let currentSelectedDate = new Date(today); 
            currentSelectedDate.setHours(0, 0, 0, 0); 

            let currentSortKey = 'time';
            let currentSortState = 'asc'; 

            // --- MOCK DATA FOR EVENTS ---
            const allMockEvents = [
                // Events for Today (dynamically adjusted below for current date)
                { time: '22:00', type: 'TECHNO_INDUSTRIAL', location: 'Concrete Factory', status: 'ACTIVE', date: '2024-10-26' },
                { time: '23:30', type: 'ACID_HOUSE', location: 'Underground Warehouse X', status: 'ACTIVE', date: '2024-10-26' },
                { time: '21:00', type: 'DEEP_MINIMAL', location: 'The Sound Chamber', status: 'ENDED', date: '2024-10-26' },
                { time: '00:00', type: 'BREAKBEAT_NIGHT', location: 'Lost Alley Club', status: 'CANCELLED', date: '2024-10-26' },
                { time: '20:00', type: 'HOUSE_GROOVE', location: 'Rooftop Garden', status: 'SOLD_OUT', date: '2024-10-26' },
                { time: '18:00', type: 'TECHNO_INDUSTRIAL', location: 'Old Power Plant', status: 'ACTIVE', date: '2024-10-26' },
                { time: '23:00', type: 'ACID_HOUSE', location: 'The Boiler Room', status: 'ACTIVE', date: '2024-10-26' },
                { time: '19:00', type: 'HOUSE_GROOVE', location: 'Hidden Loft', status: 'ENDED', date: '2024-10-26' },
                // Events for Tomorrow (day after mock 2024-10-26)
                { time: '14:00', type: 'AMBIENT_SESSIONS', location: 'Botanical Dome', status: 'ACTIVE', date: '2024-10-27' },
                { time: '22:00', type: 'DISCO_FUNK', location: 'Glitter Ball Club', status: 'ACTIVE', date: '2024-10-27' },
                // Events for a future Friday (day after mock 2024-10-26 + some days to reach next Fri)
                { time: '20:00', type: 'TRANCE_CLASSICS', location: 'Cosmic Arena', status: 'ACTIVE', date: '2024-11-01' },
                { time: '23:00', type: 'TECHNO_INDUSTRIAL', location: 'Old Power Plant', status: 'ACTIVE', date: '2024-11-01' },
                // Events for a future Saturday (day after mock 2024-10-26 + some days to reach next Sat)
                { time: '22:00', type: 'EXPERIMENTAL_SOUND', location: 'The Lab', status: 'ACTIVE', date: '2024-11-02' },
                { time: '23:00', type: 'HOUSE_GROOVE', location: 'The Terrace', status: 'ACTIVE', date: '2024-11-02' },
            ];

            function adjustMockEventDates(events) {
                const referenceDate = new Date('2024-10-26'); 
                const diffDays = Math.floor((today.getTime() - referenceDate.getTime()) / (1000 * 60 * 60 * 24));

                return events.map(event => {
                    const originalEventDate = new Date(event.date);
                    const adjustedDate = new Date(originalEventDate);
                    adjustedDate.setDate(originalEventDate.getDate() + diffDays);
                    
                    const [hours, minutes] = event.time.split(':').map(Number);
                    return {
                        ...event,
                        date: adjustedDate.toISOString().split('T')[0],
                        timeSortable: hours * 60 + minutes, 
                        fullDateObject: adjustedDate 
                    };
                });
            }
            const adjustedMockEvents = adjustMockEventDates(allMockEvents);

            // --- Date Bar Functions ---
            function formatDateToDDMM(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = monthNames[date.getMonth()];
                return `${day} ${month}`;
            }

            function getNextDayOfWeek(startDate, targetDayName) {
                const date = new Date(startDate);
                date.setHours(0, 0, 0, 0); 
                let found = false;
                for (let i = 0; i < 7; i++) { // Max 7 days to find next day of week
                    if (daysOfWeek[date.getDay()] === targetDayName && i > 0) { // i>0 to ensure it's "next" day, not same day if already matches
                        found = true;
                        break;
                    }
                    date.setDate(date.getDate() + 1);
                }
                return found ? date : null;
            }

            function updateDateBar() {
                dateBar.innerHTML = ''; 

                const displayDays = [];
                const actualToday = new Date(today); 
                actualToday.setHours(0,0,0,0);

                // Always add "TODAY" as the first option
                displayDays.push({ label: 'TODAY', date: new Date(actualToday) });

                // Define the sequence of days to attempt to display after TODAY
                const sequence = ['FRI', 'SAT', 'SUN', 'MON', 'TUE', 'WED', 'THU'];
                let currentSequenceIndex = actualToday.getDay(); // Start looking from today's day of week

                // Find the next 3 distinct days of week (excluding today if it's already displayed)
                let tempDate = new Date(actualToday);
                for (let i = 0; displayDays.length < 4 && i < 7; i++) { // Limit search to 7 days
                    tempDate.setDate(actualToday.getDate() + i); // Iterate through next 7 days
                    const dayName = daysOfWeek[tempDate.getDay()];
                    
                    // Check if this day is one of the desired "next" days (FRI, SAT, SUN)
                    // AND if it's not the same day as 'TODAY' already added,
                    // AND if it's not already in uniqueDisplayDays (preventing duplicate date objects if they have same dayName)
                    if (['FRI', 'SAT', 'SUN'].includes(dayName) && 
                        (tempDate.toDateString() !== actualToday.toDateString() || dayName === 'TODAY') && // Don't re-add TODAY unless it's the explicit TODAY object
                        !displayDays.some(d => d.date.toDateString() === tempDate.toDateString())
                    ) {
                        displayDays.push({ label: dayName, date: new Date(tempDate) });
                    }
                }
                // Refine to ensure we only show max 4 (TODAY + 3 others)
                const finalDisplayDays = displayDays.slice(0, 4);


                finalDisplayDays.forEach(dayInfo => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'day-option';
                    
                    const dayLabel = dayInfo.label;
                    const displayDate = formatDateToDDMM(dayInfo.date);
                    
                    dayElement.textContent = `${dayLabel} (${displayDate})`;
                    dayElement.dataset.fullDate = dayInfo.date.toISOString().split('T')[0]; 

                    if (currentSelectedDate.toDateString() === dayInfo.date.toDateString()) {
                        dayElement.classList.add('selected');
                    }

                    if (actualToday.toDateString() === dayInfo.date.toDateString()) {
                        dayElement.classList.add('is-today');
                    }

                    dayElement.addEventListener('click', () => {
                        currentSelectedDate = new Date(dayInfo.date);
                        currentSelectedDate.setHours(0,0,0,0);
                        updateDateBar();
                        updateEventsDisplay(); 
                    });
                    dateBar.appendChild(dayElement);
                });

                const futureDropdown = document.createElement('select');
                futureDropdown.className = 'date-dropdown';
                futureDropdown.id = 'future-date-dropdown';
                let defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Future Dates...";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                futureDropdown.appendChild(defaultOption);

                let futureDateCursor = new Date(today);
                futureDateCursor.setHours(0,0,0,0);

                // Add days from tomorrow up to 60 days in future
                for (let i = 0; i < 60; i++) { 
                    futureDateCursor.setDate(futureDateCursor.getDate() + 1); 
                    const option = document.createElement('option');
                    const formattedOptionDate = futureDateCursor.toISOString().split('T')[0];
                    option.value = formattedOptionDate;
                    option.textContent = `${daysOfWeek[futureDateCursor.getDay()]} (${formatDateToDDMM(futureDateCursor)})`;
                    futureDropdown.appendChild(option);
                }

                futureDropdown.addEventListener('change', function() {
                    const selectedDateValue = this.value;
                    if (selectedDateValue) {
                        currentSelectedDate = new Date(selectedDateValue);
                        currentSelectedDate.setHours(0,0,0,0);
                        updateDateBar(); 
                        updateEventsDisplay();
                        this.value = ""; 
                    }
                });
                dateBar.appendChild(futureDropdown);
            }

            // --- Event Display and Sorting Functions ---
            function updateEventsDisplay() {
                const filteredEvents = adjustedMockEvents.filter(event => 
                    event.fullDateObject.toDateString() === currentSelectedDate.toDateString()
                );

                let headingText;
                if (currentSelectedDate.toDateString() === today.toDateString()) {
                    headingText = 'DANCES TODAY';
                } else {
                    const dayLabel = daysOfWeek[currentSelectedDate.getDay()];
                    const displayDate = formatDateToDDMM(currentSelectedDate);
                    headingText = `DANCES for ${dayLabel} (${displayDate})`;
                }
                currentDateHeading.textContent = headingText;

                renderEvents(filteredEvents);
            }

            function renderEvents(eventsToRender) {
                eventsListContainer.innerHTML = ''; 

                if (currentSortState === 'neutral' || currentSortKey === 'time') {
                    eventsToRender.sort((a, b) => {
                        if (currentSortState === 'asc') return a.timeSortable - b.timeSortable;
                        if (currentSortState === 'desc') return b.timeSortable - a.timeSortable;
                        return a.timeSortable - b.timeSortable; 
                    });
                    eventsToRender.forEach(event => eventsListContainer.appendChild(createEventElement(event)));
                } else {
                    const groupedEvents = {};
                    eventsToRender.forEach(event => {
                        const groupKey = event[currentSortKey];
                        if (!groupedEvents[groupKey]) {
                            groupedEvents[groupKey] = [];
                        }
                        groupedEvents[groupKey].push(event);
                    });

                    const sortedGroupKeys = Object.keys(groupedEvents).sort();

                    sortedGroupKeys.forEach(groupKey => {
                        const groupHeading = document.createElement('h3');
                        groupHeading.className = 'group-heading';
                        groupHeading.textContent = `${currentSortKey.toUpperCase()}: ${groupKey.toUpperCase()}`;
                        eventsListContainer.appendChild(groupHeading);

                        groupedEvents[groupKey].sort((a, b) => a.timeSortable - b.timeSortable);
                        groupedEvents[groupKey].forEach(event => eventsListContainer.appendChild(createEventElement(event)));
                    });
                }
                
                if (eventsToRender.length === 0) {
                    const noEventsMessage = document.createElement('div');
                    noEventsMessage.textContent = '> No dances found for this date. Explore other dates or contribute to the scene.';
                    noEventsMessage.style.marginTop = '20px';
                    noEventsMessage.style.color = 'var(--text-color)';
                    eventsListContainer.appendChild(noEventsMessage);
                }
            }

            function createEventElement(event) {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-listing';
                eventDiv.innerHTML = `
                    <span class="time">${event.time}</span>
                    <span class="type">[${event.type}]</span>
                    <span class="location">${event.location}</span>
                    <span class="status">[${event.status}]</span>
                    <a href="#" class="details-link">[PROTOCOL_DETAILS]</a>
                `;
                return eventDiv;
            }

            // --- Sort/Filter Bar Logic ---
            sortFilterBar.querySelectorAll('.tab-option').forEach(tab => {
                tab.addEventListener('click', () => {
                    const key = tab.dataset.sortKey; 
                    let state = tab.dataset.sortState; 

                    if (key === 'time') {
                        if (state === 'asc') state = 'desc';
                        else if (state === 'desc') state = 'neutral';
                        else state = 'asc';
                    } else { 
                        if (state === 'neutral') state = 'group'; 
                        else state = 'neutral'; 
                    }

                    sortFilterBar.querySelectorAll('.tab-option').forEach(otherTab => {
                        if (otherTab !== tab) {
                            otherTab.dataset.sortState = 'neutral';
                            otherTab.classList.remove('active');
                            otherTab.querySelector('.arrow').textContent = '';
                        }
                    });

                    tab.dataset.sortState = state;
                    tab.classList.toggle('active', state !== 'neutral');

                    const arrowSpan = tab.querySelector('.arrow');
                    if (key === 'time') {
                        arrowSpan.textContent = state === 'asc' ? '▲' : (state === 'desc' ? '▼' : '');
                    } else { 
                        arrowSpan.textContent = state === 'group' ? '■' : ''; 
                    }
                    
                    currentSortKey = key;
                    currentSortState = state;

                    updateEventsDisplay();
                });
            });

            // --- Main Navigation Dropdown Logic ---
            mainNavDropdown.addEventListener('change', function() {
                const selectedSectionId = this.value;
                const targetSection = document.getElementById(selectedSectionId);

                contentSections.forEach(section => {
                    section.classList.remove('active');
                });

                if (targetSection) {
                    targetSection.classList.add('active');
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // If "Dances" section is selected, ensure date/sort bars are visible and update events
                if (selectedSectionId === 'dances-section') {
                    dateBar.style.display = 'flex'; 
                    sortFilterBar.style.display = 'flex'; 
                    updateEventsDisplay(); // Re-render events for the current date/sort state
                } else {
                    dateBar.style.display = 'none';
                    sortFilterBar.style.display = 'none';
                }
            });


            // Initial load setup
            // Activate the default 'TIME' sort option
            const initialTimeTab = sortFilterBar.querySelector('.tab-option[data-sort-key="time"]');
            initialTimeTab.classList.add('active'); 
            initialTimeTab.querySelector('.arrow').textContent = '▲'; 

            // Initialize the Dances section by default
            document.getElementById('dances-section').classList.add('active');
            mainNavDropdown.value = 'dances-section'; // Ensure dropdown reflects default

            updateDateBar();
            updateEventsDisplay(); // Render dances for today
        });
    </script>
</body>
</html>